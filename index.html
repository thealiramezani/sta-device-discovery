<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Device Discovery – STA MVP</title>
  <style>
    :root {
      --bg: #0b1020; --card: #121936; --muted: #8993b1; --text: #e8edff; --accent: #7aa2ff;
      --ok: #3ddc97; --warn: #ffd166; --err: #ff6b6b;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b1020 0%, #0c1430 100%); color: var(--text);
    }
    .wrap { max-width: 920px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items: center; justify-content: space-between; gap: 16px; }
    .idline { display:flex; align-items:center; gap: 10px; flex-wrap: wrap; }
    .badge { padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 12px; letter-spacing: .02em; }
    .status { background: #20304f; color: var(--text); border: 1px solid #2a3a61; }
    .ok { background: rgba(61,220,151,.15); border-color: rgba(61,220,151,.5); color: var(--ok); }
    .warn { background: rgba(255,209,102,.15); border-color: rgba(255,209,102,.5); color: var(--warn); }
    .err { background: rgba(255,107,107,.15); border-color: rgba(255,107,107,.5); color: var(--err); }
    .card { background: var(--card); border: 1px solid #223159; border-radius: 18px; padding: 18px; box-shadow: 0 10px 40px rgba(0,0,0,.25); }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px; }
    h1 { font-size: clamp(20px, 4vw, 28px); margin: 12px 0; }
    h2 { font-size: 14px; text-transform: uppercase; letter-spacing: .12em; color: var(--muted); margin: 0 0 10px; }
    .hero { display:grid; grid-template-columns: 160px 1fr; gap: 16px; align-items:center; }
    .hero img { width: 160px; height: 120px; object-fit: cover; border-radius: 12px; border: 1px solid #2a3a61; background: #0b1020; }
    .menu { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 12px; }
    .btn { display:flex; align-items:center; justify-content:center; gap: 8px; padding: 12px 14px; border-radius: 14px; background:#1a2446; border:1px solid #2a3a61; color:var(--text); text-decoration:none; font-weight:600; cursor:pointer; }
    .btn:hover { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(122,162,255,.15) inset; }
    section { margin-top: 18px; }
    ol, ul { margin: 8px 0 0 18px; }
    .small { color: var(--muted); font-size: 12px; }
    .selector { display:flex; flex-wrap:wrap; gap: 12px; margin-top: 14px; }
    .chip { text-decoration: none; color: var(--text); border:1px solid #2a3a61; padding: 10px 12px; border-radius: 999px; }
    .chip:hover { border-color: var(--accent); }
    .copylink { cursor: pointer; text-decoration: underline; color: var(--accent); }
    .toast { position: fixed; right: 16px; bottom: 16px; background:#172349; border: 1px solid #2a3a61; padding: 12px 14px; border-radius: 12px; opacity:0; transform: translateY(8px); transition: .3s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .footer { margin-top: 26px; color: var(--muted); font-size: 12px; }
    .mutebar { display:flex; align-items:center; gap: 8px; }
    .danger { color: var(--err); }
    /* detector UI */
    .bar { height: 10px; background:#1a2446; border:1px solid #2a3a61; border-radius:999px; overflow:hidden; }
    .bar > span { display:block; height:100%; width:0%; background: linear-gradient(90deg, #7aa2ff, #3ddc97); transition: width .35s ease; }
    .thumbs { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .thumbs img { width: 84px; height: 64px; object-fit: cover; border-radius: 10px; border:1px solid #2a3a61; }
    .candidates { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
    .cand { background:#151d3a; border:1px solid #2a3a61; border-radius:12px; padding:10px; max-width:220px; }
    .cand h3 { margin:0 0 4px; font-size: 14px; }
    .cand .score { font-size:12px; color:var(--muted); }
    .cand img { width:100%; height:120px; object-fit:cover; border-radius:8px; border:1px solid #2a3a61; }
    .det-row { display:flex; gap: 12px; flex-wrap:wrap; align-items:center; }
    .hidden { display:none !important; }
  </style>

  <!-- TensorFlow.js + Mobilenet (for lightweight embeddings) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="idline">
        <span class="badge status" id="deviceId">Device: —</span>
        <span class="badge ok" id="statusPill">Status: OK</span>
      </div>
      <a id="copyLink" class="small copylink" title="Copy deep link">Copy link</a>
    </header>

    <div class="card" style="margin-top:12px;">
      <div class="hero">
        <img id="deviceImg" alt="Device image" />
        <div>
          <h1 id="deviceName">Unknown Device</h1>
          <div class="small" id="deviceDesc">Open this page via QR/NFC/BLE from a tagged device.</div>
          <div class="menu" style="margin-top:12px">
            <a href="#quickstart" class="btn">Quick Start</a>
            <a href="#alarms" class="btn">Common Alarms</a>
            <a href="#troubleshoot" class="btn">Troubleshooting</a>
            <a id="manualBtn" class="btn" target="_blank" rel="noopener">Manual (PDF)</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Detect by photo -->
    <section class="card" id="detect">
      <h2>Detect by Photo</h2>
      <div class="det-row">
        <button class="btn" id="snapBtn">Take a Photo</button>
        <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" />
        <button class="btn" id="uploadBtn">Upload Image</button>
        <span class="small" id="detStatus">Model loading…</span>
      </div>
      <div class="grid" style="margin-top:12px">
        <div>
          <div class="small">Your Photo</div>
          <img id="userImg" alt="Your photo" style="width:100%;max-width:360px;height:auto;border-radius:12px;border:1px solid #2a3a61;background:#0b1020;"/>
        </div>
        <div>
          <div class="small">Confidence</div>
          <div class="bar" style="margin:8px 0 6px;"><span id="confBar"></span></div>
          <div class="small" id="confText">—</div>
          <div class="small" style="margin-top:10px">Candidates</div>
          <div id="cands" class="candidates"></div>
          <div class="det-row" style="margin-top:12px">
            <button class="btn" id="confirmBtn" disabled>Use Best Match</button>
            <a href="#chooser" class="btn">Choose Manually</a>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="quickstart">
      <h2>Quick Start</h2>
      <ol id="qsList"></ol>
    </section>

    <section class="card" id="alarms">
      <h2>Common Alarms</h2>
      <ul id="alarmList"></ul>
    </section>

    <section class="card" id="troubleshoot">
      <h2>Troubleshooting</h2>
      <ul id="tsList"></ul>
    </section>

    <!-- NEW: Device Assistant chat -->
    <section class="card" id="chatbox" style="display:none">
      <h2>Device Assistant</h2>
      <div id="chatLog" class="small" style="min-height:160px;white-space:pre-wrap"></div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="chatInput" class="btn" style="flex:1;text-align:left" placeholder="Ask about alarms, setup, troubleshooting…">
        <button id="chatSend" class="btn">Send</button>
      </div>
      <div class="small" id="chatHint" style="margin-top:6px;color:#8993b1"></div>
    </section>

    <section class="card" id="chooser" style="display:none">
      <h2>Select a device</h2>
      <div class="selector" id="selector"></div>
    </section>

    <div class="footer">
      Zero-install browser demo for STA 2026. No PHI. Content is educational, not for clinical use.
    </div>

    <div class="toast" id="toast">Link copied</div>
  </div>

  <script>
    // --- Device library ---
    // NOTE: reference Images manifests are loaded from: Devices/<folder>/Images/manifest.json
    const DEVICES = {
      "CASMED-FORESIGHT-ELITE": {
        name: "CASMED FORE-SIGHT Elite Cerebral Oximeter",
        folder: "Casmed",
        img: "Devices/Casmed/Casmed_photo.jpg",
        desc: "Near-infrared spectroscopy monitor for continuous cerebral/somatic regional oxygen saturation (rSO₂) monitoring.",
        manualUrl: "Devices/Casmed/foresight_elite.pdf",
        contact: { biomed: "+1 (555) 010-2000", clinical: "+1 (555) 010-4000" },
        quickstart: [
          "Connect the FORE-SIGHT Elite sensor cable to the patient interface module (PIM).",
          "Apply forehead sensors per placement diagram; ensure full contact.",
          "Power on; confirm startup completes without error; enter patient ID if used.",
          "Verify baseline rSO₂ values for L/R; allow 30–60 seconds to stabilize.",
          "Set alarm limits (e.g., 20% drop from baseline or absolute 50–60%)."
        ],
        alarms: [
          "Sensor Off / Poor Signal → Re-seat sensor, clean/trim site, check cable integrity.",
          "Low rSO₂ (L/R) → Confirm placement, perfusion (MAP, SpO₂), head/neck position.",
          "Module/Channel Error → Power-cycle PIM; try alternate port/sensor; call biomed if persistent.",
          "Battery Low → Connect to AC and verify charging."
        ],
        troubleshooting: [
          "No values → confirm sensor type and PIM recognition.",
          "Flatlined at ~15% → likely calibration/sensor issue; replace sensor and recheck.",
          "Inconsistent values → minimize ambient light/motion; check extracranial contamination."
        ]
      },

      "NICO2": {
        name: "NICO₂ Cardiac Output Monitor",
        folder: "Nico2",
        img: "Devices/Nico2/Nico2_photo.png",
        desc: "Non-invasive cardiac output monitor using CO₂ elimination and airway flow.",
        manualUrl: "Devices/Nico2/Service%20Manual%20Nico2.pdf",
        contact: { biomed: "+1 (555) 010-2100", clinical: "+1 (555) 010-4100" },
        quickstart: [
          "Connect the airway module and flow sensor to the main unit.",
          "Power on; verify self-test; calibrate gas sensor if prompted.",
          "Attach flow sensor and CO₂ sampling line to circuit.",
          "Start measurement; confirm CO and CO₂ readings."
        ],
        alarms: [
          "Flow Sensor Error → Check connections and tubing for leaks.",
          "CO₂ Sensor Calibration → Perform calibration or replace sensor.",
          "Low Battery → Connect power adapter and recharge."
        ],
        troubleshooting: [
          "No reading → verify patient connection and flow sensor.",
          "Inconsistent CO → check airway leaks and ventilation settings.",
          "Manual access → verify path or open via workstation with PDF access."
        ]
      },

      "Nellcor-N-395": {
        name: "Nellcor N-395 Pulse Oximeter",
        folder: "Nellcor_N_395",
        img: "Devices/Nellcor_N_395/Nellcor-N-395_photo.jpg",
        desc: "Pulse oximeter for continuous SpO₂ and pulse rate monitoring.",
        manualUrl: "Devices/Nellcor_N_395/Nellcor_N_395_manual.pdf",
        contact: { biomed: "+1 (555) 010-2200", clinical: "+1 (555) 010-4200" },
        quickstart: [
          "Connect the Nellcor sensor cable to the sensor port.",
          "Apply sensor per manual (finger or alternate site).",
          "Power on; wait for readings to stabilize."
        ],
        alarms: [
          "Sensor Off → Reposition or replace sensor.",
          "Low SpO₂ → Verify placement and perfusion.",
          "No Pulse Detected → Check site and signal quality."
        ],
        troubleshooting: [
          "No signal → Verify correct sensor type and cable integrity.",
          "Erratic readings → Reduce motion and ambient light.",
          "Blank screen → Check power and battery."
        ]
      }
    };

    // --- Helpers ---
    const $ = sel => document.querySelector(sel);
    const qs = k => new URLSearchParams(location.search).get(k);
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    function renderDevice(id){
      const d = DEVICES[id];
      const unknown = !d;
      $('#deviceId').textContent = `Device: ${id || '—'}`;
      $('#deviceName').textContent = d?.name || 'Unknown Device';
      $('#deviceDesc').textContent = d?.desc || 'Select a device below or open via QR/NFC/BLE.';
      $('#deviceImg').src = d?.img || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect width="100%" height="100%" fill="%230b1020"/><text x="50%25" y="50%25" fill="%238993b1" text-anchor="middle" font-family="Arial" font-size="24">No Image</text></svg>';
      $('#manualBtn').href = d?.manualUrl || '#';
      $('#manualBtn').classList.toggle('btn', true);

      const fill = (ul, items) => { ul.innerHTML = (items||[]).map(x => `<li>${escapeHtml(x)}</li>`).join(''); };
      fill($('#qsList'), d?.quickstart);
      fill($('#alarmList'), d?.alarms);
      fill($('#tsList'), d?.troubleshooting);

      const c = d?.contact || {};
      $('#contactBlock').innerHTML = [
        c.biomed ? `Biomed: <a href="tel:${encodeURIComponent(c.biomed)}">${escapeHtml(c.biomed)}</a>` : '',
        c.it ? `IT: <a href="tel:${encodeURIComponent(c.it)}">${escapeHtml(c.it)}</a>` : ''
      ].filter(Boolean).join(' · ');

      $('#chooser').style.display = unknown ? 'block' : 'none';

      // Show/hide chat when a device is selected
      if (!unknown) showChat(id); else $('#chatbox').style.display = 'none';
    }

    function buildSelector(){
      const el = $('#selector');
      el.innerHTML = '';
      Object.keys(DEVICES).forEach(id => {
        const a = document.createElement('a');
        a.className = 'chip';
        a.href = `?d=${encodeURIComponent(id)}`;
        a.textContent = `${DEVICES[id].name} (${id})`;
        el.appendChild(a);
      })
    }

    // Copy link
    $('#copyLink').addEventListener('click', () => {
      const url = location.origin + location.pathname + '?d=' + encodeURIComponent(qs('d')||'');
      navigator.clipboard.writeText(url).then(()=> toast('Link copied'));
    });
    function toast(msg){
      const t = $('#toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1600);
    }

    // ------------------------------
    // Detection (Mobilenet embeddings using /Images manifests)
    // ------------------------------
    const ACCEPT = 0.50;   // 50% for auto-navigate
    const MAYBE  = 0.25;   // show candidates above this

    let mobilenetModel = null;
    let refIndex = [];     // {device_id, imgUrl, vec: Float32Array}
    let bestCandidate = null;

    const detStatus = $('#detStatus');
    const confBar = $('#confBar');
    const confText = $('#confText');
    const candsEl = $('#cands');
    const confirmBtn = $('#confirmBtn');
    const userImg = $('#userImg');

    async function initDetector(){
      detStatus.textContent = 'Loading model…';
      mobilenetModel = await mobilenet.load({ version: 2, alpha: 1.0 });
      detStatus.textContent = 'Indexing reference images…';
      await buildReferenceIndexFromFolders();
      if (refIndex.length === 0) await buildReferenceIndexFromSingles();
      detStatus.textContent = 'Ready. Take or upload a photo.';
    }

    function imagesFolderFor(device){
      return `Devices/${device.folder}/Images`;
    }

    async function buildReferenceIndexFromFolders(){
      refIndex = [];
      const entries = Object.entries(DEVICES);
      for (const [device_id, d] of entries){
        const base = imagesFolderFor(d);
        const manifestUrl = `${base}/manifest.json`;
        try {
          const res = await fetch(manifestUrl, { cache: "no-store" });
          if (!res.ok) throw new Error('no manifest');
          const data = await res.json();
          const files = (data?.images || []).filter(Boolean);
          for (const fname of files){
            const url = `${base}/${fname}`;
            const el = await loadImage(url);
            const vec = await getEmbedding(el);
            refIndex.push({ device_id, imgUrl: url, vec });
          }
        } catch(e) { /* no manifest; fallback later */ }
      }
    }

    async function buildReferenceIndexFromSingles(){
      const entries = Object.entries(DEVICES);
      for (const [device_id, d] of entries){
        if (!d.img) continue;
        try {
          const el = await loadImage(d.img);
          const vec = await getEmbedding(el);
          refIndex.push({ device_id, imgUrl: d.img, vec });
        } catch(e) {}
      }
    }

    function loadImage(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = (e) => reject(e);
        img.src = src;
      });
    }

    async function getEmbedding(imgEl){
      const activation = mobilenetModel.infer(imgEl, { embedding: true }); // 1024-d
      const vec = await activation.data();
      activation.dispose();
      // L2 normalize
      const v = new Float32Array(vec.length);
      let norm = 0;
      for (let i=0;i<vec.length;i++){ norm += vec[i]*vec[i]; }
      norm = Math.sqrt(norm) || 1e-6;
      for (let i=0;i<vec.length;i++){ v[i] = vec[i] / norm; }
      return v;
    }

    function cosine(a, b){
      let s = 0;
      for (let i=0;i<a.length;i++) s += a[i]*b[i];
      return s; // [-1,1]
    }

    function aggregateByDevice(scores){
      const byDev = new Map();
      for (const r of scores){
        const cur = byDev.get(r.device_id);
        if (!cur || r.score > cur.score) byDev.set(r.device_id, r);
      }
      return Array.from(byDev.values()).sort((a,b)=> b.score - a.score);
    }

    function scoreToPercent(score){
      return Math.max(0, Math.min(1, (score + 1) / 2));
    }

    function renderCandidates(ranked){
      candsEl.innerHTML = ranked.slice(0, 2).map(r => {
        const d = DEVICES[r.device_id];
        const thumb = r.imgUrl || d.img;
        return `
          <div class="cand">
            <img src="${thumb}" alt="${escapeHtml(d.name)}">
            <h3>${escapeHtml(d.name)}</h3>
            <div class="score">score ${r.score.toFixed(3)}</div>
            <button class="btn" data-goto="${r.device_id}" style="margin-top:8px">Go to device</button>
          </div>
        `;
      }).join('');
      candsEl.querySelectorAll('button[data-goto]').forEach(btn=>{
        btn.addEventListener('click', () => navigateToDevice(btn.getAttribute('data-goto')));
      });
    }

    function updateUIWithResult(best, ranked){
      bestCandidate = best;
      const pct = scoreToPercent(best.score);
      confBar.style.width = (pct*100).toFixed(0) + '%';
      confText.textContent = `Best: ${DEVICES[best.device_id]?.name || best.device_id} — score ${best.score.toFixed(3)}`;
      renderCandidates(ranked);
      confirmBtn.disabled = best.score < MAYBE;

      if (best.score >= ACCEPT){
        detStatus.textContent = 'High confidence match — opening device…';
        navigateToDevice(best.device_id);
      } else if (best.score >= MAYBE){
        detStatus.textContent = 'Not confident yet — showing top 2 matches.';
      } else {
        detStatus.textContent = 'Low confidence — try another angle or choose manually.';
      }
    }

    async function detectFromImageElement(imgEl){
      if (refIndex.length === 0) {
        detStatus.textContent = 'No reference images indexed.';
        return;
      }
      const q = await getEmbedding(imgEl);
      const scores = refIndex.map(ref => ({ device_id: ref.device_id, imgUrl: ref.imgUrl, score: cosine(q, ref.vec) }));
      const ranked = aggregateByDevice(scores);
      updateUIWithResult(ranked[0], ranked);
    }

    function showUserImageFromFile(file){
      return new Promise((resolve, reject)=>{
        const r = new FileReader();
        r.onload = () => { userImg.src = r.result; resolve(); };
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function navigateToDevice(id){
      const url = location.origin + location.pathname + '?d=' + encodeURIComponent(id);
      history.replaceState(null, '', url);
      renderDevice(id);
      toast(`Using ${DEVICES[id]?.name || id}`);
    }

    // UI hooks for detection
    $('#snapBtn').addEventListener('click', () => $('#fileInput').click());
    $('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
    $('#fileInput').addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      detStatus.textContent = 'Analyzing photo…';
      await showUserImageFromFile(file);
      await new Promise(r => setTimeout(r, 20)); // ensure image renders
      try { await detectFromImageElement(userImg); }
      catch (err){ console.error(err); detStatus.textContent = 'Could not analyze the photo.'; }
    });
    $('#confirmBtn').addEventListener('click', () => { if (bestCandidate) navigateToDevice(bestCandidate.device_id); });

    // ------------------------------
    // Device Assistant Chat (frontend)
    // ------------------------------
    const CHAT_SERVER = 'https://sta-device-discovery.onrender.com';
    let currentDeviceId = null;
    let chatHistory = [];

    function showChat(forId){
      currentDeviceId = forId;
      $('#chatbox').style.display = DEVICES[forId] ? 'block' : 'none';
      $('#chatLog').textContent = '';
      $('#chatHint').textContent = `Answers come from the ${DEVICES[forId]?.name} manual.`;
    }

    async function askDevice(question){
      if (!currentDeviceId) return;
      const log = $('#chatLog');
      log.textContent += `\n\nYou: ${question}`;
      $('#chatInput').value = '';
      try {
        const r = await fetch(`${CHAT_SERVER}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ device_id: currentDeviceId, message: question, history: chatHistory })
        });
        const data = await r.json();
        if (data.error) throw new Error(data.error);
        const answer = (data.answer || '').trim() || '(no answer)';
        log.textContent += `\nAssistant: ${answer}`;
        chatHistory.push({ role: 'user', content: question });
        chatHistory.push({ role: 'assistant', content: answer });
      } catch (e) {
        log.textContent += `\nAssistant: (error) ${e.message}`;
      }
    }

    $('#chatSend').addEventListener('click', ()=> {
      const q = $('#chatInput').value.trim();
      if (q) askDevice(q);
    });
    $('#chatInput').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') $('#chatSend').click();
    });

    // Init page
    buildSelector();
    renderDevice(qs('d'));
    initDetector().catch(err => { console.error(err); detStatus.textContent = 'Model failed to load.'; });
  </script>
</body>
</html>
