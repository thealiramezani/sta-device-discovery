<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="description" content="Medistant - Your AI-powered medical device assistant. Instant support for medical devices in the OR." />
<meta name="author" content="Ali Ramezani" />
<title>Medistant - Medical Device Assistant</title>
<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1d4ed8;
  --secondary: #10b981;
  --bg: #f8fafc;
  --surface: #ffffff;
  --text: #0f172a;
  --text-muted: #64748b;
  --border: #e2e8f0;
  --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
  --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.1);
}

* {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

.app-container {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
}

.sidebar-header {
  padding: 24px 20px;
  border-bottom: 1px solid var(--border);
}

.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.sidebar-header h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 700;
  color: var(--primary);
}

.home-btn-sidebar {
  width: 40px;
  height: 40px;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 20px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
}

.home-btn-sidebar:hover {
  background: var(--surface);
  border-color: var(--primary);
  transform: scale(1.05);
}

.sidebar-header p {
  margin: 4px 0 0;
  font-size: 13px;
  color: var(--text-muted);
}

.tagline {
  font-style: italic;
  font-weight: 500;
}

.search-box {
  margin-top: 16px;
}

.search-box input {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  background: var(--bg);
  color: var(--text);
  outline: none;
  transition: all 0.2s;
}

.search-box input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.toggle-list-btn {
  width: 100%;
  padding: 12px 14px;
  margin-top: 12px;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.toggle-list-btn:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
}

.toggle-list-btn span {
  transition: transform 0.3s;
}

.toggle-list-btn.open span {
  transform: rotate(180deg);
}

.device-list {
  flex: 1;
  padding: 12px;
  overflow-y: auto;
  max-height: 0;
  opacity: 0;
  transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
}

.device-list.collapsed {
  max-height: 0;
  opacity: 0;
  padding: 0 12px;
  overflow: hidden;
}

.device-list.expanded {
  max-height: 1000px;
  opacity: 1;
  padding: 12px;
}

.device-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  margin-bottom: 6px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  color: var(--text);
  border: 1px solid transparent;
}

.device-item:hover {
  background: var(--bg);
  border-color: var(--border);
}

.device-item.active {
  background: linear-gradient(135deg, #dbeafe, #e0f2fe);
  border-color: var(--primary);
  box-shadow: var(--shadow);
}

.device-icon {
  width: 48px;
  height: 48px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--primary), #3b82f6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}

.device-info h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.device-info p {
  margin: 2px 0 0;
  font-size: 12px;
  color: var(--text-muted);
}

/* Main Content */
.main-content {
  flex: 1;
  overflow-y: auto;
  background: var(--bg);
}

.content-wrapper {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px;
}

.home-view {
  text-align: center;
  padding: 80px 20px;
}

.home-view h2 {
  font-size: 36px;
  font-weight: 700;
  margin: 0 0 16px;
  color: var(--text);
}

.home-view p {
  font-size: 18px;
  color: var(--text-muted);
  margin: 0;
}

.device-view {
  display: none;
}

.device-view.active {
  display: block;
}

/* Device Header */
.device-header {
  background: var(--surface);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: var(--shadow);
  display: flex;
  gap: 24px;
  align-items: start;
}

.device-image {
  width: 160px;
  height: 120px;
  border-radius: 12px;
  object-fit: cover;
  background: var(--bg);
  border: 1px solid var(--border);
  flex-shrink: 0;
}

.device-header-info {
  flex: 1;
}

.device-header-info h2 {
  margin: 0 0 8px;
  font-size: 28px;
  font-weight: 700;
  color: var(--text);
}

.device-header-info p {
  margin: 0 0 20px;
  color: var(--text-muted);
  font-size: 15px;
}

.action-buttons {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  text-decoration: none;
  border: none;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-lg);
}

.btn-secondary {
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--bg);
  border-color: var(--primary);
}

/* Content Cards */
.content-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.card {
  background: var(--surface);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
}

.card h3 {
  margin: 0 0 16px;
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}

.card-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: linear-gradient(135deg, var(--primary), #3b82f6);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.card ul, .card ol {
  margin: 0;
  padding-left: 20px;
}

.card li {
  margin-bottom: 8px;
  color: var(--text-muted);
  font-size: 14px;
}

.contact-info {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.contact-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--bg);
  border-radius: 10px;
}

.contact-item a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}

/* Chat Widget - Bottom Panel */
.chat-widget {
  position: fixed;
  bottom: 0;
  left: 280px;
  right: 0;
  z-index: 1000;
  display: none;
  box-shadow: 0 -4px 20px rgba(0,0,0,.1);
}

.chat-widget.active { display: block; }

.chat-toggle {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), #3b82f6);
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  transition: transform .2s;
  z-index: 999;
}

.chat-toggle:hover { transform: scale(1.05); }
.chat-toggle.hidden { display: none; }

.chat-container {
  background: var(--surface);
  border-top: 2px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 450px;
  max-height: 50vh;
}

.chat-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--surface);
}

.chat-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text);
}

.chat-close {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 24px;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}

.chat-close:hover {
  background: var(--bg);
  color: var(--text);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: var(--bg);
}

.chat-message {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.6;
}

.chat-message.user {
  background: linear-gradient(135deg, var(--primary), #3b82f6);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.chat-message.assistant {
  background: var(--surface);
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
}

.chat-message.assistant strong {
  color: var(--primary);
  font-weight: 600;
}

.chat-message.thinking {
  background: var(--surface);
  color: var(--text-muted);
  align-self: flex-start;
  font-style: italic;
  border: 1px solid var(--border);
}

.chat-input-area {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  background: var(--surface);
}

.chat-input-wrapper {
  display: flex;
  gap: 12px;
  max-width: 1200px;
  margin: 0 auto;
}

.chat-input {
  flex: 1;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  outline: none;
  /* Prevent zoom on iOS */
  font-size: 16px;
}

.chat-input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.chat-send {
  background: linear-gradient(135deg, var(--primary), #3b82f6);
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: transform .2s;
}

.chat-send:hover { 
  transform: scale(1.05);
  box-shadow: var(--shadow-lg);
}

.chat-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.hidden { display: none !important; }

/* Footer */
.app-footer {
  background: var(--surface);
  border-top: 1px solid var(--border);
  padding: 16px 32px;
  margin-top: auto;
}

.footer-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  font-size: 14px;
}

.footer-left {
  color: var(--text);
}

.footer-right {
  color: var(--text-muted);
}

.footer-right a {
  color: var(--primary);
  text-decoration: none;
  font-weight: 600;
}

.footer-right a:hover {
  text-decoration: underline;
}

.footer-disclaimer {
  margin-top: 8px;
  font-size: 12px;
  color: var(--text-muted);
  text-align: center;
}

/* Detection Card */
.detection-card {
  background: var(--surface);
  border-radius: 16px;
  padding: 32px;
  margin: 40px auto;
  max-width: 800px;
  box-shadow: var(--shadow-lg);
  border: 1px solid var(--border);
}

.detection-card h3 {
  margin: 0 0 8px;
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
}

.detection-card > p {
  margin: 0 0 24px;
  color: var(--text-muted);
  font-size: 15px;
}

.detection-controls {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-bottom: 20px;
}

.detection-status {
  text-align: center;
  padding: 12px;
  background: var(--bg);
  border-radius: 10px;
  color: var(--text-muted);
  font-size: 14px;
  margin-bottom: 20px;
}

.detection-results {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-top: 24px;
}

.detection-preview img {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: contain;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--bg);
}

.confidence-bar {
  width: 100%;
  height: 12px;
  background: var(--bg);
  border-radius: 999px;
  overflow: hidden;
  margin-bottom: 12px;
  border: 1px solid var(--border);
}

.confidence-fill {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  transition: width 0.5s ease;
}

.confidence-text {
  font-size: 14px;
  color: var(--text-muted);
  margin-bottom: 16px;
}

.candidates {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.candidate-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.candidate-item img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.candidate-info {
  flex: 1;
}

.candidate-info h4 {
  margin: 0 0 4px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text);
}

.candidate-info p {
  margin: 0;
  font-size: 12px;
  color: var(--text-muted);
}

.candidate-item .btn {
  padding: 8px 16px;
  font-size: 13px;
}

/* Responsive */
@media (max-width: 768px) {
  .sidebar {
    width: 100%;
    height: auto;
    border-right: none;
    border-bottom: 1px solid var(--border);
    max-height: none;
  }
  
  .device-list.expanded {
    max-height: 400px;
  }
  
  .app-container {
    flex-direction: column;
  }
  
  .footer-content {
    flex-direction: column;
    text-align: center;
    gap: 8px;
  }
  
  .chat-widget {
    left: 0;
    right: 0;
    width: 100%;
  }
  
  .chat-container {
    height: 500px;
    max-height: 70vh;
  }
  
  .chat-header {
    padding: 12px 16px;
  }
  
  .chat-header h3 {
    font-size: 15px;
  }
  
  .chat-close {
    display: flex;
    width: 40px;
    height: 40px;
    font-size: 32px;
    flex-shrink: 0;
    min-width: 40px;
  }
  
  .chat-messages {
    padding: 12px 16px;
  }
  
  .chat-input-area {
    padding: 12px 16px;
  }
  
  .chat-message {
    max-width: 85%;
    font-size: 14px;
  }
  
  .chat-input {
    font-size: 16px;
    padding: 10px 14px;
  }
  
  .voice-btn,
  .voice-toggle {
    font-size: 18px;
    padding: 10px 12px;
    min-width: 44px;
  }
  
  .chat-send {
    padding: 10px 16px;
    min-width: 70px;
  }
  
  .chat-close {
    display: flex;
    width: 36px;
    height: 36px;
    font-size: 28px;
  }
  
  .device-header {
    flex-direction: column;
  }
  
  .content-grid {
    grid-template-columns: 1fr;
  }
  
  .detection-results {
    grid-template-columns: 1fr;
  }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
</head>
<body>
<div class="app-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="header-top">
        <h1>üíä Medistant</h1>
        <button class="home-btn-sidebar hidden" id="homeBtnSidebar" onclick="showDevice(null)">
          üè†
        </button>
      </div>
      <p class="tagline">Your AI-powered medical device assistant</p>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç Search devices..." />
      </div>
      <button class="toggle-list-btn" id="toggleListBtn">
        <span id="toggleIcon">‚ñº</span> Device List
      </button>
    </div>
    <nav class="device-list collapsed" id="deviceList"></nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="content-wrapper">
      <!-- Home View -->
      <div class="home-view" id="homeView">
        <h2>üëã Welcome to Medistant</h2>
        <p>Your AI-powered assistant for medical devices. Select a device or detect it by photo.</p>
        
        <!-- Camera Detection -->
        <div class="detection-card">
          <h3>üì∏ Detect Device by Photo</h3>
          <p>Take a photo of your device and we'll identify it for you</p>
          
          <div class="detection-controls">
            <button class="btn btn-primary" id="snapBtn">üì∑ Take Photo</button>
            <button class="btn btn-secondary" id="uploadBtn">üìÅ Upload Image</button>
            <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" />
          </div>
          
          <div id="detectionStatus" class="detection-status">Model loading...</div>
          
          <div id="detectionResults" class="detection-results hidden">
            <div class="detection-preview">
              <img id="userImg" alt="Your photo" />
            </div>
            <div class="detection-info">
              <div class="confidence-bar">
                <div class="confidence-fill" id="confBar"></div>
              </div>
              <div id="confText" class="confidence-text">‚Äî</div>
              <div id="candidates" class="candidates"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Device Views (generated dynamically) -->
      <div id="deviceViews"></div>
    </div>
  </main>
</div>

<footer class="app-footer" role="contentinfo" aria-label="Site footer">
  <div class="footer-content">
    <div class="footer-left">Developed by <strong>Ali Ramezani</strong></div>
    <div class="footer-right">Contact: <a href="mailto:ali.ramezani@utah.edu">ali.ramezani@utah.edu</a></div>
  </div>
  <div class="footer-disclaimer">¬© <span id="year"></span> Medistant</div>
</footer>
<script>document.getElementById('year').textContent = new Date().getFullYear();</script>

<!-- Chat Widget -->
<button class="chat-toggle hidden" id="chatToggle">üí¨</button>
<div class="chat-widget" id="chatWidget">
  <div class="chat-container">
    <div class="chat-header">
      <h3 id="chatTitle">Ask about this device</h3>
      <button class="chat-close" id="chatClose">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message assistant">
        Hi! I can help answer questions about this device based on its manual. What would you like to know?
      </div>
    </div>
    <div class="chat-input-area">
      <div class="chat-input-wrapper">
        <button class="voice-btn" id="voiceBtn" title="Voice input">üé§</button>
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question or use voice..." />
        <button class="voice-toggle" id="voiceToggle" title="Toggle voice responses">üîä</button>
        <button class="chat-send" id="chatSend">Send</button>
      </div>
      <div class="voice-status hidden" id="voiceStatus">Listening...</div>
    </div>
  </div>
</div>

<script>
const DEVICES = {
  "CASMED-FORESIGHT-ELITE": {
    name: "CASMED FORE-SIGHT Elite",
    shortName: "Cerebral Oximeter",
    folder: "Casmed",
    img: "Devices/Casmed/Casmed_photo.jpg",
    icon: "üß†",
    desc: "Near-infrared spectroscopy monitor for continuous cerebral/somatic regional oxygen saturation (rSO‚ÇÇ) monitoring.",
    manualUrl: "Devices/Casmed/foresight_elite.pdf",
    contact: {
      biomed: "+1 (555) 010-2000",
      clinical: "+1 (555) 010-4000"
    },
    quickstart: [
      "Connect the FORE-SIGHT Elite sensor cable to the patient interface module (PIM).",
      "Apply forehead sensors per placement diagram; ensure full contact.",
      "Power on; confirm startup completes without error; enter patient ID if used.",
      "Verify baseline rSO‚ÇÇ values for L/R; allow 30‚Äì60 seconds to stabilize.",
      "Set alarm limits (e.g., 20% drop from baseline or absolute 50‚Äì60%)."
    ],
    alarms: [
      "Sensor Off / Poor Signal ‚Üí Re-seat sensor, clean/trim site, check cable integrity.",
      "Low rSO‚ÇÇ (L/R) ‚Üí Confirm placement, perfusion (MAP, SpO‚ÇÇ), head/neck position.",
      "Module/Channel Error ‚Üí Power-cycle PIM; try alternate port/sensor; call biomed if persistent.",
      "Battery Low ‚Üí Connect to AC and verify charging."
    ],
    troubleshooting: [
      "No values ‚Üí confirm sensor type and PIM recognition.",
      "Flatlined at ~15% ‚Üí likely calibration/sensor issue; replace sensor and recheck.",
      "Inconsistent values ‚Üí minimize ambient light/motion; check extracranial contamination."
    ]
  },
  "NICO2": {
    name: "NICO‚ÇÇ Monitor",
    shortName: "Cardiac Output",
    folder: "Nico2",
    img: "Devices/Nico2/Nico2_photo.png",
    icon: "‚ù§Ô∏è",
    desc: "Non-invasive cardiac output monitor using CO‚ÇÇ elimination and airway flow.",
    manualUrl: "Devices/Nico2/Service%20Manual%20Nico2.pdf",
    contact: {
      biomed: "+1 (555) 010-2100",
      clinical: "+1 (555) 010-4100"
    },
    quickstart: [
      "Connect the airway module and flow sensor to the main unit.",
      "Power on; verify self-test; calibrate gas sensor if prompted.",
      "Attach flow sensor and CO‚ÇÇ sampling line to circuit.",
      "Start measurement; confirm CO and CO‚ÇÇ readings."
    ],
    alarms: [
      "Flow Sensor Error ‚Üí Check connections and tubing for leaks.",
      "CO‚ÇÇ Sensor Calibration ‚Üí Perform calibration or replace sensor.",
      "Low Battery ‚Üí Connect power adapter and recharge."
    ],
    troubleshooting: [
      "No reading ‚Üí verify patient connection and flow sensor.",
      "Inconsistent CO ‚Üí check airway leaks and ventilation settings.",
      "Manual access ‚Üí verify path or open via workstation with PDF access."
    ]
  },
  "Nellcor-N-395": {
    name: "Nellcor N-395",
    shortName: "Pulse Oximeter",
    folder: "Nellcor_N_395",
    img: "Devices/Nellcor_N_395/Nellcor-N-395_photo.jpg",
    icon: "ü´Ä",
    desc: "Pulse oximeter for continuous SpO‚ÇÇ and pulse rate monitoring.",
    manualUrl: "Devices/Nellcor_N_395/Nellcor_N_395_manual.pdf",
    contact: {
      biomed: "+1 (555) 010-2200",
      clinical: "+1 (555) 010-4200"
    },
    quickstart: [
      "Connect the Nellcor sensor cable to the sensor port.",
      "Apply sensor per manual (finger or alternate site).",
      "Power on; wait for readings to stabilize."
    ],
    alarms: [
      "Sensor Off ‚Üí Reposition or replace sensor.",
      "Low SpO‚ÇÇ ‚Üí Verify placement and perfusion.",
      "No Pulse Detected ‚Üí Check site and signal quality."
    ],
    troubleshooting: [
      "No signal ‚Üí Verify correct sensor type and cable integrity.",
      "Erratic readings ‚Üí Reduce motion and ambient light.",
      "Blank screen ‚Üí Check power and battery."
    ]
  }
};

const $ = sel => document.querySelector(sel);
const qs = k => new URLSearchParams(location.search).get(k);

window.currentDeviceId = null;
window.chatThreadId = null;

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

// Build sidebar
function buildSidebar() {
  const list = $('#deviceList');
  Object.keys(DEVICES).forEach(id => {
    const d = DEVICES[id];
    const item = document.createElement('a');
    item.className = 'device-item';
    item.href = `?d=${id}`;
    item.dataset.deviceId = id;
    item.dataset.searchText = `${d.name} ${d.shortName} ${d.desc}`.toLowerCase();
    item.innerHTML = `
      <div class="device-icon">${d.icon}</div>
      <div class="device-info">
        <h3>${d.name}</h3>
        <p>${d.shortName}</p>
      </div>
    `;
    list.appendChild(item);
  });
}

// Toggle device list
const toggleListBtn = $('#toggleListBtn');
const toggleIcon = $('#toggleIcon');
const deviceList = $('#deviceList');

toggleListBtn.addEventListener('click', () => {
  const isExpanded = deviceList.classList.contains('expanded');
  
  if (isExpanded) {
    deviceList.classList.remove('expanded');
    deviceList.classList.add('collapsed');
    toggleListBtn.classList.remove('open');
  } else {
    deviceList.classList.remove('collapsed');
    deviceList.classList.add('expanded');
    toggleListBtn.classList.add('open');
  }
});

// Search functionality
$('#searchInput').addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase().trim();
  const items = document.querySelectorAll('.device-item');
  
  // Auto-expand list when searching
  if (query !== '' && deviceList.classList.contains('collapsed')) {
    deviceList.classList.remove('collapsed');
    deviceList.classList.add('expanded');
    toggleListBtn.classList.add('open');
  }
  
  items.forEach(item => {
    const searchText = item.dataset.searchText;
    if (query === '' || searchText.includes(query)) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
});

// Build device views
function buildDeviceViews() {
  const container = $('#deviceViews');
  Object.keys(DEVICES).forEach(id => {
    const d = DEVICES[id];
    const view = document.createElement('div');
    view.className = 'device-view';
    view.id = `view-${id}`;
    view.innerHTML = `
      <div class="device-header">
        <img class="device-image" src="${d.img}" alt="${d.name}" />
        <div class="device-header-info">
          <h2>${d.name}</h2>
          <p>${d.desc}</p>
          <div class="action-buttons">
            <a href="${d.manualUrl}" class="btn btn-primary" target="_blank">üìÑ View Manual</a>
            <button class="btn btn-secondary" onclick="document.getElementById('chatToggle').click()">üí¨ Ask AI</button>
          </div>
        </div>
      </div>

      <div class="content-grid">
        <div class="card">
          <h3><div class="card-icon">üöÄ</div> Quick Start</h3>
          <ol>${d.quickstart.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ol>
        </div>
        <div class="card">
          <h3><div class="card-icon">‚ö†Ô∏è</div> Common Alarms</h3>
          <ul>${d.alarms.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul>
        </div>
      </div>

      <div class="card">
        <h3><div class="card-icon">üîß</div> Troubleshooting</h3>
        <ul>${d.troubleshooting.map(s => `<li>${escapeHtml(s)}</li>`).join('')}</ul>
      </div>

      <div class="card" style="margin-top: 20px;">
        <h3><div class="card-icon">üìû</div> Contact Information</h3>
        <div class="contact-info">
          ${d.contact.biomed ? `<div class="contact-item">üì± Biomed: <a href="tel:${d.contact.biomed}">${d.contact.biomed}</a></div>` : ''}
          ${d.contact.clinical ? `<div class="contact-item">üè• Clinical: <a href="tel:${d.contact.clinical}">${d.contact.clinical}</a></div>` : ''}
        </div>
      </div>
    `;
    container.appendChild(view);
  });
}

// Show device
function showDevice(id) {
  window.currentDeviceId = id;
  window.chatThreadId = null;

  // Update sidebar
  document.querySelectorAll('.device-item').forEach(item => {
    item.classList.toggle('active', item.dataset.deviceId === id);
  });

  // Update views
  $('#homeView').style.display = id ? 'none' : 'block';
  document.querySelectorAll('.device-view').forEach(view => {
    view.classList.toggle('active', view.id === `view-${id}`);
  });

  // Show/hide home button in sidebar
  const homeBtnSidebar = $('#homeBtnSidebar');
  if (id) {
    homeBtnSidebar.classList.remove('hidden');
    
    // Auto-collapse device list when a device is selected
    deviceList.classList.remove('expanded');
    deviceList.classList.add('collapsed');
    toggleListBtn.classList.remove('open');
  } else {
    homeBtnSidebar.classList.add('hidden');
  }

  // Update chat
  const chatToggle = $('#chatToggle');
  if (id && DEVICES[id]) {
    chatToggle.classList.remove('hidden');
    $('#chatTitle').textContent = `Ask about ${DEVICES[id].name}`;
    $('#chatMessages').innerHTML = '<div class="chat-message assistant">Hi! I can help answer questions about this device based on its manual. What would you like to know?</div>';
  } else {
    chatToggle.classList.add('hidden');
    $('#chatWidget').classList.remove('active');
  }

  // Update URL
  const url = new URL(window.location);
  if (id) {
    url.searchParams.set('d', id);
  } else {
    url.searchParams.delete('d');
  }
  history.replaceState(null, '', url);

  // Scroll to top
  $('.main-content').scrollTo({ top: 0, behavior: 'smooth' });
}

// Chat functionality
const chatWidget = $('#chatWidget');
const chatToggle = $('#chatToggle');
const chatClose = $('#chatClose');
const chatMessages = $('#chatMessages');
const chatInput = $('#chatInput');
const chatSend = $('#chatSend');
const voiceBtn = $('#voiceBtn');
const voiceToggle = $('#voiceToggle');
const voiceStatus = $('#voiceStatus');

// Voice settings
let voiceEnabled = localStorage.getItem('voiceEnabled') === 'true';
let recognition = null;
let synthesis = window.speechSynthesis;

// Initialize voice recognition
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    chatInput.value = transcript;
    voiceBtn.classList.remove('recording');
    voiceStatus.classList.add('hidden');
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    voiceBtn.classList.remove('recording');
    voiceStatus.classList.add('hidden');
  };
  
  recognition.onend = () => {
    voiceBtn.classList.remove('recording');
    voiceStatus.classList.add('hidden');
  };
}

// Voice input button
voiceBtn.addEventListener('click', () => {
  if (!recognition) {
    alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
    return;
  }
  
  if (voiceBtn.classList.contains('recording')) {
    recognition.stop();
  } else {
    voiceBtn.classList.add('recording');
    voiceStatus.classList.remove('hidden');
    recognition.start();
  }
});

// Voice output toggle
if (voiceEnabled) {
  voiceToggle.classList.add('active');
}

voiceToggle.addEventListener('click', () => {
  voiceEnabled = !voiceEnabled;
  localStorage.setItem('voiceEnabled', voiceEnabled);
  voiceToggle.classList.toggle('active', voiceEnabled);
  
  if (voiceEnabled) {
    speak('Voice responses enabled');
  } else {
    synthesis.cancel();
  }
});

// Text-to-speech function
function speak(text) {
  if (!voiceEnabled || !synthesis) return;
  
  // Cancel any ongoing speech
  synthesis.cancel();
  
  // Remove markdown and special characters for better speech
  const cleanText = text
    .replace(/\*\*([^\*]+)\*\*/g, '$1')
    .replace(/„Äê[^„Äë]*„Äë/g, '')
    .replace(/[‚Ä¢\-]/g, '')
    .replace(/\n/g, '. ');
  
  const utterance = new SpeechSynthesisUtterance(cleanText);
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;
  
  // Use a natural-sounding voice if available
  const voices = synthesis.getVoices();
  const preferredVoice = voices.find(v => v.lang.startsWith('en') && v.name.includes('Natural')) 
    || voices.find(v => v.lang.startsWith('en'));
  if (preferredVoice) {
    utterance.voice = preferredVoice;
  }
  
  synthesis.speak(utterance);
}

chatToggle.addEventListener('click', () => {
  chatWidget.classList.add('active');
  chatToggle.style.display = 'none';
  chatInput.focus();
});

chatClose.addEventListener('click', () => {
  chatWidget.classList.remove('active');
  chatToggle.style.display = 'flex';
});

function formatMarkdown(text) {
  text = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  text = text.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
  text = text.replace(/^- /gm, '‚Ä¢ ');
  text = text.replace(/\n/g, '<br>');
  return text;
}

// Response cache for faster loading
const responseCache = new Map();

function getCacheKey(deviceId, message) {
  return `${deviceId}:${message.toLowerCase().trim()}`;
}

async function sendMessage() {
  const message = chatInput.value.trim();
  if (!message || !window.currentDeviceId) return;

  const userMsg = document.createElement('div');
  userMsg.className = 'chat-message user';
  userMsg.textContent = message;
  chatMessages.appendChild(userMsg);

  chatInput.value = '';
  chatInput.disabled = true;
  chatSend.disabled = true;
  voiceBtn.disabled = true;

  const thinkingMsg = document.createElement('div');
  thinkingMsg.className = 'chat-message thinking';
  thinkingMsg.textContent = 'Thinking...';
  chatMessages.appendChild(thinkingMsg);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  try {
    // Check cache first
    const cacheKey = getCacheKey(window.currentDeviceId, message);
    let responseText;
    
    if (responseCache.has(cacheKey)) {
      console.log('Using cached response');
      thinkingMsg.textContent = 'Retrieved from cache...';
      await new Promise(r => setTimeout(r, 300)); // Brief delay for UX
      responseText = responseCache.get(cacheKey);
      window.chatThreadId = null; // Don't need thread for cached responses
    } else {
      // Make API call
      const response = await fetch('https://device-chat-cloudflare.sta-lab.workers.dev/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: message,
          deviceId: window.currentDeviceId,
          threadId: window.chatThreadId || null
        })
      });

      if (!response.ok) throw new Error(`Server error: ${response.status}`);

      const data = await response.json();
      window.chatThreadId = data.threadId;
      responseText = data.response;
      
      // Cache the response
      responseCache.set(cacheKey, responseText);
      console.log('Response cached');
    }

    thinkingMsg.remove();

    const assistantMsg = document.createElement('div');
    assistantMsg.className = 'chat-message assistant';
    assistantMsg.innerHTML = formatMarkdown(responseText);
    chatMessages.appendChild(assistantMsg);
    
    // Speak the response if voice is enabled
    if (voiceEnabled) {
      speak(responseText);
    }

  } catch (error) {
    console.error('Chat error:', error);
    thinkingMsg.textContent = 'Sorry, I encountered an error. Please make sure the backend server is running.';
    thinkingMsg.className = 'chat-message assistant';
  }

  chatInput.disabled = false;
  chatSend.disabled = false;
  voiceBtn.disabled = false;
  chatMessages.scrollTop = chatMessages.scrollHeight;
  chatInput.focus();
}

chatSend.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Keyboard shortcut for voice input (Ctrl/Cmd + Shift + V)
document.addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'V') {
    e.preventDefault();
    if (chatWidget.classList.contains('active')) {
      voiceBtn.click();
    }
  }
});

// Clear cache function (for testing - can be called from console)
window.clearChatCache = () => {
  responseCache.clear();
  console.log('Chat cache cleared');
};

// Handle navigation
document.addEventListener('click', (e) => {
  const item = e.target.closest('.device-item');
  if (item) {
    e.preventDefault();
    showDevice(item.dataset.deviceId);
  }
});

// Initialize
buildSidebar();
buildDeviceViews();
showDevice(qs('d'));

// ============================================
// DEVICE DETECTION (Camera/Upload)
// ============================================
const ACCEPT = 0.50;
const MAYBE = 0.25;
let mobilenetModel = null;
let refIndex = [];

const detStatus = $('#detectionStatus');
const confBar = $('#confBar');
const confText = $('#confText');
const candsEl = $('#candidates');
const userImg = $('#userImg');
const detResults = $('#detectionResults');

async function initDetector(){
  detStatus.textContent = 'Loading AI model...';
  try {
    mobilenetModel = await mobilenet.load({ version: 2, alpha: 1.0 });
    detStatus.textContent = 'Indexing device images...';
    await buildReferenceIndex();
    detStatus.textContent = '‚úÖ Ready! Take or upload a photo to detect your device';
  } catch(err) {
    console.error(err);
    detStatus.textContent = '‚ùå Failed to load detection model';
  }
}

async function buildReferenceIndex(){
  refIndex = [];
  const entries = Object.entries(DEVICES);
  for (const [device_id, d] of entries){
    if (!d.img) continue;
    try {
      const el = await loadImage(d.img);
      const vec = await getEmbedding(el);
      refIndex.push({ device_id, imgUrl: d.img, vec });
    } catch(e) {
      console.error(`Failed to load ${device_id}:`, e);
    }
  }
}

function loadImage(src){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = (e) => reject(e);
    img.src = src;
  });
}

async function getEmbedding(imgEl){
  const activation = mobilenetModel.infer(imgEl, { embedding: true });
  const vec = await activation.data();
  activation.dispose();
  
  const v = new Float32Array(vec.length);
  let norm = 0;
  for (let i=0;i<vec.length;i++){
    norm += vec[i]*vec[i];
  }
  norm = Math.sqrt(norm) || 1e-6;
  for (let i=0;i<vec.length;i++){
    v[i] = vec[i] / norm;
  }
  return v;
}

function cosine(a, b){
  let s = 0;
  for (let i=0;i<a.length;i++) s += a[i]*b[i];
  return s;
}

function aggregateByDevice(scores){
  const byDev = new Map();
  for (const r of scores){
    const cur = byDev.get(r.device_id);
    if (!cur || r.score > cur.score) byDev.set(r.device_id, r);
  }
  return Array.from(byDev.values()).sort((a,b)=> b.score - a.score);
}

function scoreToPercent(score){
  return Math.max(0, Math.min(1, (score + 1) / 2));
}

function renderCandidates(ranked){
  candsEl.innerHTML = ranked.slice(0, 2).map(r => {
    const d = DEVICES[r.device_id];
    const thumb = r.imgUrl || d.img;
    const pct = (scoreToPercent(r.score) * 100).toFixed(0);
    return `<div class="candidate-item">
      <img src="${thumb}" alt="${escapeHtml(d.name)}">
      <div class="candidate-info">
        <h4>${escapeHtml(d.name)}</h4>
        <p>Confidence: ${pct}%</p>
      </div>
      <button class="btn btn-primary" onclick="showDevice('${r.device_id}')">View Device</button>
    </div>`;
  }).join('');
}

function updateUIWithResult(best, ranked){
  const pct = scoreToPercent(best.score);
  confBar.style.width = (pct*100).toFixed(0) + '%';
  confText.textContent = `Best match: ${DEVICES[best.device_id]?.name || best.device_id} (${(pct*100).toFixed(0)}% confidence)`;
  renderCandidates(ranked);
  
  if (best.score >= ACCEPT){
    detStatus.textContent = '‚úÖ High confidence match found!';
    detStatus.style.background = 'linear-gradient(135deg, #d1fae5, #a7f3d0)';
    detStatus.style.color = '#065f46';
    setTimeout(() => showDevice(best.device_id), 2000);
  } else if (best.score >= MAYBE){
    detStatus.textContent = '‚ö†Ô∏è Possible matches found - please review';
    detStatus.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
    detStatus.style.color = '#92400e';
  } else {
    detStatus.textContent = '‚ùå Low confidence - try another angle or select manually';
    detStatus.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
    detStatus.style.color = '#991b1b';
  }
}

async function detectFromImageElement(imgEl){
  if (refIndex.length === 0) {
    detStatus.textContent = 'No reference images indexed.';
    return;
  }
  const q = await getEmbedding(imgEl);
  const scores = refIndex.map(ref => ({
    device_id: ref.device_id,
    imgUrl: ref.imgUrl,
    score: cosine(q, ref.vec)
  }));
  const ranked = aggregateByDevice(scores);
  updateUIWithResult(ranked[0], ranked);
}

function showUserImageFromFile(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => {
      userImg.src = r.result;
      resolve();
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

$('#snapBtn').addEventListener('click', () => $('#fileInput').click());
$('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
$('#fileInput').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  
  detStatus.textContent = 'Analyzing photo...';
  detStatus.style.background = 'var(--bg)';
  detStatus.style.color = 'var(--text-muted)';
  detResults.classList.remove('hidden');
  
  await showUserImageFromFile(file);
  await new Promise(r => setTimeout(r, 20));
  
  try {
    await detectFromImageElement(userImg);
  } catch (err){
    console.error(err);
    detStatus.textContent = '‚ùå Could not analyze the photo.';
    detStatus.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
    detStatus.style.color = '#991b1b';
  }
});

// Initialize detector
initDetector();
</script>
</body>
</html>