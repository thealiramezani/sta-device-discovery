<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Device Discovery â€“ STA MVP</title>
<style>
/* loading bar */
.loadingbar {
  height: 3px;
  background:#1a2446;
  border-radius:2px;
  overflow:hidden;
  margin-bottom:8px;
}
.loadingbar > span {
  display:block;
  height:100%;
  width:30%;
  animation: slide 1.1s infinite linear;
  background: linear-gradient(90deg, #7aa2ff, #3ddc97);
}
@keyframes slide {
  0% { margin-left:-30% }
  100% { margin-left:100% }
}
.hidden { display:none !important; }
:root {
  --bg: #0b1020;
  --card: #121936;
  --muted: #8993b1;
  --text: #e8edff;
  --accent: #7aa2ff;
  --ok: #3ddc97;
  --warn: #ffd166;
  --err: #ff6b6b;
}
html, body { height: 100%; }
body {
  margin: 0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  background: linear-gradient(180deg, #0b1020 0%, #0c1430 100%);
  color: var(--text);
}
.wrap {
  max-width: 920px;
  margin: 0 auto;
  padding: 24px;
}
header {
  display:flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
}
.idline {
  display:flex;
  align-items:center;
  gap: 10px;
  flex-wrap: wrap;
}
.badge {
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 600;
  font-size: 12px;
  letter-spacing: .02em;
}
.status {
  background: #20304f;
  color: var(--text);
  border: 1px solid #2a3a61;
}
.ok {
  background: rgba(61,220,151,.15);
  border-color: rgba(61,220,151,.5);
  color: var(--ok);
}
.warn {
  background: rgba(255,209,102,.15);
  border-color: rgba(255,209,102,.5);
  color: var(--warn);
}
.err {
  background: rgba(255,107,107,.15);
  border-color: rgba(255,107,107,.5);
  color: var(--err);
}
.card {
  background: var(--card);
  border: 1px solid #223159;
  border-radius: 18px;
  padding: 18px;
  box-shadow: 0 10px 40px rgba(0,0,0,.25);
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
}
h1 {
  font-size: clamp(20px, 4vw, 28px);
  margin: 12px 0;
}
h2 {
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
  margin: 0 0 10px;
}
.hero {
  display:grid;
  grid-template-columns: 160px 1fr;
  gap: 16px;
  align-items:center;
}
.hero img {
  width: 160px;
  height: 120px;
  object-fit: cover;
  border-radius: 12px;
  border: 1px solid #2a3a61;
  background: #0b1020;
}
.menu {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 10px;
  margin-top: 12px;
}
.btn {
  display:flex;
  align-items:center;
  justify-content:center;
  gap: 8px;
  padding: 12px 14px;
  border-radius: 14px;
  background:#1a2446;
  border:1px solid #2a3a61;
  color:var(--text);
  text-decoration:none;
  font-weight:600;
  cursor:pointer;
}
.btn:hover {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(122,162,255,.15) inset;
}
section { margin-top: 18px; }
ol, ul { margin: 8px 0 0 18px; }
.small {
  color: var(--muted);
  font-size: 12px;
}
.selector {
  display:flex;
  flex-wrap:wrap;
  gap: 12px;
  margin-top: 14px;
}
.chip {
  text-decoration: none;
  color: var(--text);
  border:1px solid #2a3a61;
  padding: 10px 12px;
  border-radius: 999px;
}
.chip:hover { border-color: var(--accent); }
.copylink {
  cursor: pointer;
  text-decoration: underline;
  color: var(--accent);
}
.toast {
  position: fixed;
  right: 16px;
  bottom: 16px;
  background:#172349;
  border: 1px solid #2a3a61;
  padding: 12px 14px;
  border-radius: 12px;
  opacity:0;
  transform: translateY(8px);
  transition: .3s ease;
  z-index: 2000;
}
.toast.show {
  opacity: 1;
  transform: translateY(0);
}
.footer {
  margin-top: 26px;
  color: var(--muted);
  font-size: 12px;
}
.mutebar {
  display:flex;
  align-items:center;
  gap: 8px;
}
.danger { color: var(--err); }

/* detector UI */
.bar {
  height: 10px;
  background:#1a2446;
  border:1px solid #2a3a61;
  border-radius:999px;
  overflow:hidden;
}
.bar > span {
  display:block;
  height:100%;
  width:0%;
  background: linear-gradient(90deg, #7aa2ff, #3ddc97);
  transition: width .35s ease;
}
.thumbs {
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}
.thumbs img {
  width: 84px;
  height: 64px;
  object-fit: cover;
  border-radius: 10px;
  border:1px solid #2a3a61;
}
.candidates {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  margin-top:10px;
}
.cand {
  background:#151d3a;
  border:1px solid #2a3a61;
  border-radius:12px;
  padding:10px;
  max-width:220px;
}
.cand h3 {
  margin:0 0 4px;
  font-size: 14px;
}
.cand .score {
  font-size:12px;
  color:var(--muted);
}
.cand img {
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #2a3a61;
}
.det-row {
  display:flex;
  gap: 12px;
  flex-wrap:wrap;
  align-items:center;
}
.spacer {
  flex: 1 1 auto;
}

/* Chat Widget Styles */
.chat-widget {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 380px;
  max-width: calc(100vw - 48px);
  z-index: 1000;
  display: none;
}
.chat-widget.active { display: block; }
.chat-toggle {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #7aa2ff, #3ddc97);
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(122,162,255,.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  color: white;
  transition: transform .2s;
  z-index: 999;
}
.chat-toggle:hover { transform: scale(1.05); }
.chat-toggle.hidden { display: none; }
.chat-container {
  background: var(--card);
  border: 1px solid #223159;
  border-radius: 18px;
  box-shadow: 0 10px 40px rgba(0,0,0,.35);
  display: flex;
  flex-direction: column;
  height: 500px;
  max-height: 70vh;
}
.chat-header {
  padding: 16px;
  border-bottom: 1px solid #223159;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.chat-header h3 {
  margin: 0;
  font-size: 16px;
  color: var(--text);
}
.chat-close {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 24px;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
}
.chat-close:hover {
  background: #1a2446;
  color: var(--text);
}
.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.chat-message {
  max-width: 85%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.5;
}
.chat-message.user {
  background: linear-gradient(135deg, #7aa2ff, #5d8cff);
  color: white;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.chat-message.assistant {
  background: #1a2446;
  color: var(--text);
  align-self: flex-start;
  border-bottom-left-radius: 4px;
  border: 1px solid #2a3a61;
}
.chat-message.thinking {
  background: #1a2446;
  color: var(--muted);
  align-self: flex-start;
  font-style: italic;
}
.chat-input-area {
  padding: 16px;
  border-top: 1px solid #223159;
}
.chat-input-wrapper {
  display: flex;
  gap: 8px;
}
.chat-input {
  flex: 1;
  background: #1a2446;
  border: 1px solid #2a3a61;
  border-radius: 12px;
  padding: 10px 14px;
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  outline: none;
}
.chat-input:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(122,162,255,.15);
}
.chat-send {
  background: linear-gradient(135deg, #7aa2ff, #5d8cff);
  border: none;
  border-radius: 12px;
  padding: 10px 18px;
  color: white;
  font-weight: 600;
  cursor: pointer;
  transition: transform .2s;
}
.chat-send:hover { transform: scale(1.05); }
.chat-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
</head>
<body>
<div class="wrap">
<header>
  <div class="idline">
    <span class="badge status" id="deviceId">Device: â€”</span>
    <span class="badge ok" id="statusPill">Status: OK</span>
  </div>
  <div style="display:flex; align-items:center; gap:10px;">
    <a id="copyLink" class="small copylink" title="Copy deep link">Copy link</a>
    <a id="homeBtn" class="btn" title="Back to device chooser">Home</a>
  </div>
</header>

<div class="card" style="margin-top:12px;">
  <div class="hero">
    <img id="deviceImg" alt="Device image" />
    <div>
      <h1 id="deviceName">Unknown Device</h1>
      <div class="small" id="deviceDesc">Open this page via QR/NFC/BLE from a tagged device.</div>
      <div class="menu" style="margin-top:12px">
        <a href="#quickstart" class="btn">Quick Start</a>
        <a href="#alarms" class="btn">Common Alarms</a>
        <a href="#troubleshoot" class="btn">Troubleshooting</a>
        <a id="manualBtn" class="btn" target="_blank" rel="noopener">Manual (PDF)</a>
      </div>
    </div>
  </div>
</div>

<section class="card">
  <h2>Contacts</h2>
  <div id="contactBlock" class="small"></div>
</section>

<section class="card" id="detect">
  <h2>Detect by Photo</h2>
  <div class="det-row">
    <button class="btn" id="snapBtn">Take a Photo</button>
    <input type="file" id="fileInput" accept="image/*" capture="environment" class="hidden" />
    <button class="btn" id="uploadBtn">Upload Image</button>
    <span class="small" id="detStatus">Model loadingâ€¦</span>
  </div>
  <div class="grid" style="margin-top:12px">
    <div>
      <div class="small">Your Photo</div>
      <img id="userImg" alt="Your photo" style="width:100%;max-width:360px;height:auto;border-radius:12px;border:1px solid #2a3a61;background:#0b1020;"/>
    </div>
    <div>
      <div class="small">Confidence</div>
      <div class="bar" style="margin:8px 0 6px;"><span id="confBar"></span></div>
      <div class="small" id="confText">â€”</div>
      <div class="small" style="margin-top:10px">Candidates</div>
      <div id="cands" class="candidates"></div>
      <div class="det-row" style="margin-top:12px">
        <button class="btn" id="confirmBtn" disabled>Use Best Match</button>
        <a href="#chooser" class="btn">Choose Manually</a>
      </div>
    </div>
  </div>
</section>

<section class="card" id="quickstart">
  <h2>Quick Start</h2>
  <ol id="qsList"></ol>
</section>

<section class="card" id="alarms">
  <h2>Common Alarms</h2>
  <ul id="alarmList"></ul>
</section>

<section class="card" id="troubleshoot">
  <h2>Troubleshooting</h2>
  <ul id="tsList"></ul>
</section>

<section class="card" id="chooser" style="display:none">
  <h2>Select a device</h2>
  <div class="selector" id="selector"></div>
</section>

<div class="footer">
  Zero-install browser demo for STA 2026. No PHI. Content is educational, not for clinical use.
</div>

<div class="toast" id="toast">Link copied</div>
</div>

<!-- Chat Widget -->
<button class="chat-toggle hidden" id="chatToggle">ðŸ’¬</button>
<div class="chat-widget" id="chatWidget">
  <div class="chat-container">
    <div class="chat-header">
      <h3 id="chatTitle">Ask about this device</h3>
      <button class="chat-close" id="chatClose">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message assistant">
        Hi! I can help answer questions about this device based on its manual. What would you like to know?
      </div>
    </div>
    <div class="chat-input-area">
      <div class="chat-input-wrapper">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question..." />
        <button class="chat-send" id="chatSend">Send</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- Device library ---
const DEVICES = {
  "CASMED-FORESIGHT-ELITE": {
    name: "CASMED FORE-SIGHT Elite Cerebral Oximeter",
    folder: "Casmed",
    img: "Devices/Casmed/Casmed_photo.jpg",
    desc: "Near-infrared spectroscopy monitor for continuous cerebral/somatic regional oxygen saturation (rSOâ‚‚) monitoring.",
    manualUrl: "Devices/Casmed/foresight_elite.pdf",
    contact: {
      biomed: "+1 (555) 010-2000",
      clinical: "+1 (555) 010-4000"
    },
    quickstart: [
      "Connect the FORE-SIGHT Elite sensor cable to the patient interface module (PIM).",
      "Apply forehead sensors per placement diagram; ensure full contact.",
      "Power on; confirm startup completes without error; enter patient ID if used.",
      "Verify baseline rSOâ‚‚ values for L/R; allow 30â€“60 seconds to stabilize.",
      "Set alarm limits (e.g., 20% drop from baseline or absolute 50â€“60%)."
    ],
    alarms: [
      "Sensor Off / Poor Signal â†’ Re-seat sensor, clean/trim site, check cable integrity.",
      "Low rSOâ‚‚ (L/R) â†’ Confirm placement, perfusion (MAP, SpOâ‚‚), head/neck position.",
      "Module/Channel Error â†’ Power-cycle PIM; try alternate port/sensor; call biomed if persistent.",
      "Battery Low â†’ Connect to AC and verify charging."
    ],
    troubleshooting: [
      "No values â†’ confirm sensor type and PIM recognition.",
      "Flatlined at ~15% â†’ likely calibration/sensor issue; replace sensor and recheck.",
      "Inconsistent values â†’ minimize ambient light/motion; check extracranial contamination."
    ]
  },
  "NICO2": {
    name: "NICOâ‚‚ Cardiac Output Monitor",
    folder: "Nico2",
    img: "Devices/Nico2/Nico2_photo.png",
    desc: "Non-invasive cardiac output monitor using COâ‚‚ elimination and airway flow.",
    manualUrl: "Devices/Nico2/Service%20Manual%20Nico2.pdf",
    contact: {
      biomed: "+1 (555) 010-2100",
      clinical: "+1 (555) 010-4100"
    },
    quickstart: [
      "Connect the airway module and flow sensor to the main unit.",
      "Power on; verify self-test; calibrate gas sensor if prompted.",
      "Attach flow sensor and COâ‚‚ sampling line to circuit.",
      "Start measurement; confirm CO and COâ‚‚ readings."
    ],
    alarms: [
      "Flow Sensor Error â†’ Check connections and tubing for leaks.",
      "COâ‚‚ Sensor Calibration â†’ Perform calibration or replace sensor.",
      "Low Battery â†’ Connect power adapter and recharge."
    ],
    troubleshooting: [
      "No reading â†’ verify patient connection and flow sensor.",
      "Inconsistent CO â†’ check airway leaks and ventilation settings.",
      "Manual access â†’ verify path or open via workstation with PDF access."
    ]
  },
  "Nellcor-N-395": {
    name: "Nellcor N-395 Pulse Oximeter",
    folder: "Nellcor_N_395",
    img: "Devices/Nellcor_N_395/Nellcor-N-395_photo.jpg",
    desc: "Pulse oximeter for continuous SpOâ‚‚ and pulse rate monitoring.",
    manualUrl: "Devices/Nellcor_N_395/Nellcor_N_395_manual.pdf",
    contact: {
      biomed: "+1 (555) 010-2200",
      clinical: "+1 (555) 010-4200"
    },
    quickstart: [
      "Connect the Nellcor sensor cable to the sensor port.",
      "Apply sensor per manual (finger or alternate site).",
      "Power on; wait for readings to stabilize."
    ],
    alarms: [
      "Sensor Off â†’ Reposition or replace sensor.",
      "Low SpOâ‚‚ â†’ Verify placement and perfusion.",
      "No Pulse Detected â†’ Check site and signal quality."
    ],
    troubleshooting: [
      "No signal â†’ Verify correct sensor type and cable integrity.",
      "Erratic readings â†’ Reduce motion and ambient light.",
      "Blank screen â†’ Check power and battery."
    ]
  }
};

// --- Helpers & state ---
const $ = sel => document.querySelector(sel);
const qs = k => new URLSearchParams(location.search).get(k);
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

window.currentDeviceId = null;
window.chatThreadId = null;

function renderDevice(id){
  window.currentDeviceId = id;
  window.chatThreadId = null; // Reset thread when switching devices
  
  const d = DEVICES[id];
  const unknown = !d;
  
  $('#deviceId').textContent = `Device: ${id || 'â€”'}`;
  $('#deviceName').textContent = d?.name || 'Unknown Device';
  $('#deviceDesc').textContent = d?.desc || 'Select a device below or open via QR/NFC/BLE.';
  $('#deviceImg').src = d?.img || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect width="100%" height="100%" fill="%230b1020"/><text x="50%25" y="50%25" fill="%238993b1" text-anchor="middle" font-family="Arial" font-size="24">No Image</text></svg>';
  $('#manualBtn').href = d?.manualUrl || '#';
  $('#manualBtn').classList.toggle('btn', true);
  
  const fill = (ul, items) => {
    ul.innerHTML = (items||[]).map(x => `<li>${escapeHtml(x)}</li>`).join('');
  };
  fill($('#qsList'), d?.quickstart);
  fill($('#alarmList'), d?.alarms);
  fill($('#tsList'), d?.troubleshooting);
  
  const c = d?.contact || {};
  $('#contactBlock').innerHTML = [
    c.biomed ? `Biomed: <a href="tel:${encodeURIComponent(c.biomed)}">${escapeHtml(c.biomed)}</a>` : '',
    c.it ? `IT: <a href="tel:${encodeURIComponent(c.it)}">${escapeHtml(c.it)}</a>` : ''
  ].filter(Boolean).join(' Â· ');
  
  $('#chooser').style.display = unknown ? 'block' : 'none';
  
  // Clear chat messages except welcome
  $('#chatMessages').innerHTML = '<div class="chat-message assistant">Hi! I can help answer questions about this device based on its manual. What would you like to know?</div>';
  
  // Show/hide chat based on device selection
  const chatToggle = $('#chatToggle');
  if (id && d) {
    chatToggle.classList.remove('hidden');
    $('#chatTitle').textContent = `Ask about ${d.name}`;
  } else {
    chatToggle.classList.add('hidden');
    $('#chatWidget').classList.remove('active');
  }
}

function buildSelector(){
  const el = $('#selector');
  el.innerHTML = '';
  Object.keys(DEVICES).forEach(id => {
    const a = document.createElement('a');
    a.className = 'chip';
    a.href = `?d=${encodeURIComponent(id)}`;
    a.textContent = `${DEVICES[id].name} (${id})`;
    el.appendChild(a);
  });
}

$('#copyLink').addEventListener('click', () => {
  const url = location.origin + location.pathname + '?d=' + encodeURIComponent(qs('d')||'');
  navigator.clipboard.writeText(url).then(()=> toast('Link copied'));
});

function toast(msg){
  const t = $('#toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1600);
}

$('#homeBtn').addEventListener('click', () => {
  const url = location.origin + location.pathname;
  history.replaceState(null, '', url);
  renderDevice(null);
  toast('Back to home');
  window.scrollTo({ top: 0, behavior: 'smooth' });
});

// ------------------------------ 
// Detection (Mobilenet embeddings using /Images manifests)
// ------------------------------
const ACCEPT = 0.50;
const MAYBE = 0.25;
let mobilenetModel = null;
let refIndex = [];
let bestCandidate = null;

const detStatus = $('#detStatus');
const confBar = $('#confBar');
const confText = $('#confText');
const candsEl = $('#cands');
const confirmBtn = $('#confirmBtn');
const userImg = $('#userImg');

async function initDetector(){
  detStatus.textContent = 'Loading modelâ€¦';
  mobilenetModel = await mobilenet.load({ version: 2, alpha: 1.0 });
  detStatus.textContent = 'Indexing reference imagesâ€¦';
  await buildReferenceIndexFromFolders();
  if (refIndex.length === 0) await buildReferenceIndexFromSingles();
  detStatus.textContent = 'Ready. Take or upload a photo.';
}

function imagesFolderFor(device){
  return `Devices/${device.folder}/Images`;
}

async function buildReferenceIndexFromFolders(){
  refIndex = [];
  const entries = Object.entries(DEVICES);
  for (const [device_id, d] of entries){
    const base = imagesFolderFor(d);
    const manifestUrl = `${base}/manifest.json`;
    try {
      const res = await fetch(manifestUrl, { cache: "no-store" });
      if (!res.ok) throw new Error('no manifest');
      const data = await res.json();
      const files = (data?.images || []).filter(Boolean);
      for (const fname of files){
        const url = `${base}/${fname}`;
        const el = await loadImage(url);
        const vec = await getEmbedding(el);
        refIndex.push({ device_id, imgUrl: url, vec });
      }
    } catch(e) { /* no manifest; fallback later */ }
  }
}

async function buildReferenceIndexFromSingles(){
  const entries = Object.entries(DEVICES);
  for (const [device_id, d] of entries){
    if (!d.img) continue;
    try {
      const el = await loadImage(d.img);
      const vec = await getEmbedding(el);
      refIndex.push({ device_id, imgUrl: d.img, vec });
    } catch(e) {}
  }
}

function loadImage(src){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = (e) => reject(e);
    img.src = src;
  });
}

async function getEmbedding(imgEl){
  const activation = mobilenetModel.infer(imgEl, { embedding: true });
  const vec = await activation.data();
  activation.dispose();
  
  const v = new Float32Array(vec.length);
  let norm = 0;
  for (let i=0;i<vec.length;i++){
    norm += vec[i]*vec[i];
  }
  norm = Math.sqrt(norm) || 1e-6;
  for (let i=0;i<vec.length;i++){
    v[i] = vec[i] / norm;
  }
  return v;
}

function cosine(a, b){
  let s = 0;
  for (let i=0;i<a.length;i++) s += a[i]*b[i];
  return s;
}

function aggregateByDevice(scores){
  const byDev = new Map();
  for (const r of scores){
    const cur = byDev.get(r.device_id);
    if (!cur || r.score > cur.score) byDev.set(r.device_id, r);
  }
  return Array.from(byDev.values()).sort((a,b)=> b.score - a.score);
}

function scoreToPercent(score){
  return Math.max(0, Math.min(1, (score + 1) / 2));
}

function renderCandidates(ranked){
  candsEl.innerHTML = ranked.slice(0, 2).map(r => {
    const d = DEVICES[r.device_id];
    const thumb = r.imgUrl || d.img;
    return `<div class="cand">
      <img src="${thumb}" alt="${escapeHtml(d.name)}">
      <h3>${escapeHtml(d.name)}</h3>
      <div class="score">score ${r.score.toFixed(3)}</div>
      <button class="btn" data-goto="${r.device_id}" style="margin-top:8px">Go to device</button>
    </div>`;
  }).join('');
  candsEl.querySelectorAll('button[data-goto]').forEach(btn=>{
    btn.addEventListener('click', () => navigateToDevice(btn.getAttribute('data-goto')));
  });
}

function updateUIWithResult(best, ranked){
  bestCandidate = best;
  const pct = scoreToPercent(best.score);
  confBar.style.width = (pct*100).toFixed(0) + '%';
  confText.textContent = `Best: ${DEVICES[best.device_id]?.name || best.device_id} â€” score ${best.score.toFixed(3)}`;
  renderCandidates(ranked);
  confirmBtn.disabled = best.score < MAYBE;
  if (best.score >= ACCEPT){
    detStatus.textContent = 'High confidence match â€” opening deviceâ€¦';
    navigateToDevice(best.device_id);
  } else if (best.score >= MAYBE){
    detStatus.textContent = 'Not confident yet â€” showing top 2 matches.';
  } else {
    detStatus.textContent = 'Low confidence â€” try another angle or choose manually.';
  }
}

async function detectFromImageElement(imgEl){
  if (refIndex.length === 0) {
    detStatus.textContent = 'No reference images indexed.';
    return;
  }
  const q = await getEmbedding(imgEl);
  const scores = refIndex.map(ref => ({
    device_id: ref.device_id,
    imgUrl: ref.imgUrl,
    score: cosine(q, ref.vec)
  }));
  const ranked = aggregateByDevice(scores);
  updateUIWithResult(ranked[0], ranked);
}

function showUserImageFromFile(file){
  return new Promise((resolve, reject)=>{
    const r = new FileReader();
    r.onload = () => {
      userImg.src = r.result;
      resolve();
    };
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function navigateToDevice(id){
  const url = location.origin + location.pathname + '?d=' + encodeURIComponent(id);
  history.replaceState(null, '', url);
  renderDevice(id);
  toast(`Using ${DEVICES[id]?.name || id}`);
}

$('#snapBtn').addEventListener('click', () => $('#fileInput').click());
$('#uploadBtn').addEventListener('click', () => $('#fileInput').click());
$('#fileInput').addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  detStatus.textContent = 'Analyzing photoâ€¦';
  await showUserImageFromFile(file);
  await new Promise(r => setTimeout(r, 20));
  try {
    await detectFromImageElement(userImg);
  } catch (err){
    console.error(err);
    detStatus.textContent = 'Could not analyze the photo.';
  }
});

$('#confirmBtn').addEventListener('click', () => {
  if (bestCandidate) navigateToDevice(bestCandidate.device_id);
});

// ============================================
// CHAT FUNCTIONALITY
// ============================================

const chatWidget = $('#chatWidget');
const chatToggle = $('#chatToggle');
const chatClose = $('#chatClose');
const chatMessages = $('#chatMessages');
const chatInput = $('#chatInput');
const chatSend = $('#chatSend');

// Open chat
chatToggle.addEventListener('click', () => {
  chatWidget.classList.add('active');
  chatToggle.style.display = 'none';
  chatInput.focus();
});

// Close chat
chatClose.addEventListener('click', () => {
  chatWidget.classList.remove('active');
  chatToggle.style.display = 'flex';
});

// Send message function
async function sendMessage() {
  const message = chatInput.value.trim();
  if (!message || !window.currentDeviceId) return;
  
  // Add user message to chat
  const userMsg = document.createElement('div');
  userMsg.className = 'chat-message user';
  userMsg.textContent = message;
  chatMessages.appendChild(userMsg);
  
  // Clear input and disable controls
  chatInput.value = '';
  chatInput.disabled = true;
  chatSend.disabled = true;
  
  // Add thinking indicator
  const thinkingMsg = document.createElement('div');
  thinkingMsg.className = 'chat-message thinking';
  thinkingMsg.textContent = 'Thinking...';
  chatMessages.appendChild(thinkingMsg);
  chatMessages.scrollTop = chatMessages.scrollHeight;
  
  try {
    // Call backend API
    const response = await fetch('http://localhost:3000/api/chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        deviceId: window.currentDeviceId,
        threadId: window.chatThreadId || null
      })
    });
    
    if (!response.ok) {
      throw new Error(`Server error: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Store thread ID for conversation context
    window.chatThreadId = data.threadId;
    
    // Remove thinking message
    thinkingMsg.remove();
    
    // Add assistant message
    const assistantMsg = document.createElement('div');
    assistantMsg.className = 'chat-message assistant';
    assistantMsg.textContent = data.response;
    chatMessages.appendChild(assistantMsg);
    
  } catch (error) {
    console.error('Chat error:', error);
    thinkingMsg.textContent = 'Sorry, I encountered an error. Please make sure the backend server is running at http://localhost:3000';
    thinkingMsg.className = 'chat-message assistant';
    thinkingMsg.style.color = 'var(--err)';
  }
  
  // Re-enable controls
  chatInput.disabled = false;
  chatSend.disabled = false;
  chatMessages.scrollTop = chatMessages.scrollHeight;
  chatInput.focus();
}

// Send button click
chatSend.addEventListener('click', sendMessage);

// Enter key to send
chatInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Init page
buildSelector();
renderDevice(qs('d'));
initDetector().catch(err => {
  console.error(err);
  detStatus.textContent = 'Model failed to load.';
});
</script>
</body>
</html>